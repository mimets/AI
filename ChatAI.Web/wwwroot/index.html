<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Chat AI Console - Federico Furlani</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050608;
      --bg-panel: #0b0e13;
      --border: #222633;
      --accent: #00d0ff;
      --accent-soft: #1098ff;
      --text: #f2f4ff;
      --text-soft: #a0a4b8;
      --error: #ff5370;
      --ok: #6df18b;
      --code-bg: #050608;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: Consolas, "Cascadia Code", monospace;
      background: radial-gradient(circle at top, #111522 0, #050608 40%);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .app {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    /* HEADER */

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 14px;
      border-radius: 8px;
      background: linear-gradient(90deg, #050608, #0b0e13);
      border: 1px solid var(--border);
      box-shadow: 0 0 0 1px rgba(0,0,0,0.6), 0 18px 35px rgba(0,0,0,0.6);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .dot.red { background: #ff5f57; }
    .dot.yellow { background: #ffbd2e; }
    .dot.green { background: #28c840; }

    .title {
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-size: 13px;
      color: var(--text-soft);
    }

    .title span {
      color: var(--accent);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      color: var(--text-soft);
    }

    .badge {
      border-radius: 999px;
      padding: 2px 10px;
      border: 1px solid var(--border);
      background: #050608;
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      user-select: none;
    }

    .badge.active {
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 12px rgba(0,208,255,0.35);
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    /* LAYOUT PRINCIPALE */

    .main {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 12px;
      flex: 1;
      min-height: 0;
    }

    .panels {
      display: grid;
      grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.3fr);
      gap: 10px;
      flex: 1;
      min-height: 0;
    }

    @media (max-width: 800px) {
      .panels {
        grid-template-columns: minmax(0,1fr);
        grid-auto-rows: auto;
      }
    }

    .panel {
      background: linear-gradient(180deg, #050608, #050608 45%, #0b0e13 100%);
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      box-shadow: 0 16px 30px rgba(0,0,0,0.6);
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .panel-header {
      font-size: 12px;
      color: var(--text-soft);
      border-bottom: 1px solid #161926;
      padding-bottom: 6px;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-header span {
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-size: 11px;
    }

    .panel-header small {
      font-size: 11px;
      color: #5c6279;
    }

    /* SUGGERIMENTI / COMANDI */

    .commands {
      font-size: 11px;
      color: var(--text-soft);
      line-height: 1.5;
      overflow: auto;
      max-height: 220px;
      white-space: pre;
    }

    .commands strong {
      color: var(--accent-soft);
    }

    /* AREA CHAT */

    .chat {
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .messages {
      flex: 1;
      min-height: 0;
      background: #050608;
      border-radius: 6px;
      border: 1px solid #1a1e29;
      padding: 8px 10px;
      overflow-y: auto;
      font-size: 12px;
      line-height: 1.5;
      white-space: pre-wrap;
    }

    .msg-user {
      color: #7bf5ff;
      margin-bottom: 4px;
    }

    .msg-ai {
      color: #7bff97;
      margin-bottom: 10px;
    }

    .msg-time {
      color: #61667a;
      font-size: 11px;
    }

    .separator {
      border-top: 1px solid #151926;
      margin: 8px 0;
    }

    /* BOX CODICE */

    .code-box {
      border-radius: 8px;
      border: 1px solid #30364a;
      background: radial-gradient(circle at top left, #151a24 0, #050608 60%);
      margin-top: 8px;
      overflow: hidden;
    }

    .code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 8px;
      background: #050608;
      border-bottom: 1px solid #30364a;
      font-size: 11px;
      color: var(--text-soft);
    }

    .code-title {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .code-title span {
      font-size: 12px;
    }

    .badge-copy {
      border-radius: 999px;
      border: 1px solid #3a425b;
      padding: 2px 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .badge-copy:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .code-body {
      padding: 8px 10px;
      background: var(--code-bg);
      color: #b6d8ff;
      font-size: 12px;
      white-space: pre;
      overflow-x: auto;
    }

    /* INPUT */

    .input-area {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 6px;
    }

    .input-row {
      display: flex;
      gap: 6px;
    }

    .input-row textarea {
      flex: 1;
      min-height: 46px;
      max-height: 140px;
      resize: vertical;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #262a38;
      background: #050608;
      color: var(--text);
      font-family: inherit;
      font-size: 13px;
    }

    .input-row button {
      padding: 6px 14px;
      border-radius: 6px;
      border: none;
      background: linear-gradient(135deg, var(--accent-soft), var(--accent));
      color: #020308;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .input-row button:disabled {
      opacity: 0.5;
      cursor: wait;
    }

    .status-line {
      font-size: 11px;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* LOADING BAR */

    .loading {
      font-size: 11px;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .loading-bar {
      position: relative;
      width: 120px;
      height: 4px;
      border-radius: 999px;
      background: #151926;
      overflow: hidden;
    }

    .loading-bar-inner {
      position: absolute;
      top: 0;
      left: -40%;
      width: 40%;
      height: 100%;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      animation: slide 1.1s linear infinite;
    }

    @keyframes slide {
      0% { left: -40%; }
      100% { left: 100%; }
    }

    .status-ok {
      color: var(--ok);
    }

    .status-error {
      color: var(--error);
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- HEADER -->
    <header class="header">
      <div class="header-left">
        <div class="dot red"></div>
        <div class="dot yellow"></div>
        <div class="dot green"></div>
        <div class="title">
          CHAT AI CONSOLE Â· <span>Federico Furlani</span>
        </div>
      </div>
      <div class="header-right">
        <span id="modeLabel">MODE:</span>
        <div id="badgeCompact" class="badge active">
          <div class="badge-dot"></div>
          COMPACT
        </div>
        <div id="badgeVerbose" class="badge">
          <div class="badge-dot"></div>
          VERBOSE
        </div>
      </div>
    </header>

    <!-- MAIN -->
    <div class="main">
      <div class="panels">
        <!-- Chat panel -->
        <section class="panel">
          <div class="panel-header">
            <span>SESSIONE</span>
            <small id="sessionInfo">Pronto</small>
          </div>

          <div class="chat">
            <div id="messages" class="messages">
              <!-- Messaggi verranno inseriti qui -->
            </div>

            <div class="input-area">
              <div class="input-row">
                <textarea id="input" placeholder="Scrivi qui la tua domanda..."></textarea>
                <button id="send">
                  <span>Invia</span> â–¶
                </button>
              </div>
              <div class="status-line">
                <div class="loading" id="loading" style="opacity:0;">
                  <div class="loading-bar">
                    <div class="loading-bar-inner"></div>
                  </div>
                  <span id="loadingText">Sto pensando...</span>
                </div>
                <div id="status" class="status-ok">Pronto</div>
              </div>
            </div>
          </div>
        </section>

        <!-- Commands panel -->
        <aside class="panel">
          <div class="panel-header">
            <span>COMANDI</span>
            <small>Alias come nella console</small>
          </div>
          <div class="commands">
=== COMANDI ===
/clear   /cls   - Cancella chat
/save    /s     - Salva cronologia (solo lato server)
/load    /l     - Carica cronologia (solo lato server)
/verbose /v     - Risposte dettagliate
/compact /c     - Risposte brevi (default)
/copy    /cp    - Copia l'ultimo codice
/model   /m     - Cambia modello (/model nome)
/help    /h /?  - Aiuto
/exit    /quit   - (Solo console locale)
==============

Suggerimenti:
- Fai domande brevi e dirette.
- Per relazioni lunghe usa modalitÃ  VERBOSE.
- Puoi scrivere "continua" per far proseguire la risposta.
          </div>
        </aside>
      </div>
    </div>
  </div>

  <script>
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const messagesEl = document.getElementById('messages');
    const statusEl = document.getElementById('status');
    const loadingEl = document.getElementById('loading');
    const loadingTextEl = document.getElementById('loadingText');
    const sessionInfoEl = document.getElementById('sessionInfo');
    const badgeCompact = document.getElementById('badgeCompact');
    const badgeVerbose = document.getElementById('badgeVerbose');

    let currentMode = 'compact';
    let lastCode = '';

    function setMode(mode) {
      currentMode = mode;
      if (mode === 'compact') {
        badgeCompact.classList.add('active');
        badgeVerbose.classList.remove('active');
        sessionInfoEl.textContent = 'ModalitÃ  COMPACT (risposte brevi)';
      } else {
        badgeVerbose.classList.add('active');
        badgeCompact.classList.remove('active');
        sessionInfoEl.textContent = 'ModalitÃ  VERBOSE (risposte dettagliate)';
      }
    }

    badgeCompact.addEventListener('click', () => setMode('compact'));
    badgeVerbose.addEventListener('click', () => setMode('verbose'));

    function appendMessage(role, text) {
      const time = new Date();
      const hh = String(time.getHours()).padStart(2, '0');
      const mm = String(time.getMinutes()).padStart(2, '0');
      const timeTag = `[${hh}:${mm}]`;

      const divTime = document.createElement('div');
      divTime.className = 'msg-time';
      divTime.textContent = timeTag;

      const div = document.createElement('div');
      div.className = role === 'user' ? 'msg-user' : 'msg-ai';

      const label = role === 'user' ? 'Tu' : 'AI';
      div.textContent = `${label}: ${text}`;

      messagesEl.appendChild(divTime);
      messagesEl.appendChild(div);
      messagesEl.appendChild(document.createElement('div')).className = 'separator';
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function showLoading(show, text = 'Sto pensando...') {
      loadingEl.style.opacity = show ? '1' : '0';
      loadingTextEl.textContent = text;
    }

    async function ask() {
      const text = input.value.trim();
      if (!text || sendBtn.disabled) return;

      appendMessage('user', text);
      input.value = '';

      statusEl.className = 'status-ok';
      statusEl.textContent = 'Inviato';
      showLoading(true);

      sendBtn.disabled = true;

      try {
        const res = await fetch('/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text })
        });

        const data = await res.json();
        if (!res.ok) {
          statusEl.className = 'status-error';
          statusEl.textContent = data.error || 'Errore';
          appendMessage('ai', 'Errore: ' + (data.error || 'sconosciuto'));
        } else {
          statusEl.className = 'status-ok';
          statusEl.textContent = 'Pronto';

          let reply = data.reply || '';

          // Estrai eventuale blocco codice tra [CODICE_START] e [CODICE_END]
          const codeStart = reply.indexOf('[CODICE_START]');
          const codeEnd = reply.indexOf('[CODICE_END]');
          let codeBlock = '';
          if (codeStart !== -1 && codeEnd !== -1 && codeEnd > codeStart) {
            codeBlock = reply.substring(
              codeStart + '[CODICE_START]'.length,
              codeEnd
            ).trim();
            reply = reply.substring(0, codeStart).trim();
          }

          appendMessage('ai', reply || '(nessuna risposta)');

          if (codeBlock) {
            renderCodeBox(codeBlock);
            lastCode = codeBlock;
          }
        }
      } catch (e) {
        statusEl.className = 'status-error';
        statusEl.textContent = 'Errore di rete';
        appendMessage('ai', 'Errore di rete: ' + e.message);
      } finally {
        sendBtn.disabled = false;
        showLoading(false);
      }
    }

    function renderCodeBox(code) {
      const box = document.createElement('div');
      box.className = 'code-box';

      const header = document.createElement('div');
      header.className = 'code-header';

      const title = document.createElement('div');
      title.className = 'code-title';
      title.innerHTML = 'ðŸ“‹ <span>CODE</span>';

      const btn = document.createElement('div');
      btn.className = 'badge-copy';
      btn.textContent = 'Copia';

      btn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(code);
          btn.textContent = 'Copiato âœ“';
          setTimeout(() => (btn.textContent = 'Copia'), 1500);
        } catch {
          btn.textContent = 'Ctrl+C';
          setTimeout(() => (btn.textContent = 'Copia'), 1500);
        }
      });

      header.appendChild(title);
      header.appendChild(btn);

      const body = document.createElement('pre');
      body.className = 'code-body';
      body.textContent = code;

      box.appendChild(header);
      box.appendChild(body);

      messagesEl.appendChild(box);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    sendBtn.addEventListener('click', ask);
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        ask();
      }
    });

    // ModalitÃ  iniziale
    setMode('compact');
  </script>
</body>
</html>
